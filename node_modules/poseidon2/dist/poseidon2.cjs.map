{"version":3,"file":"poseidon2.cjs","sources":["../src/core/F1Field.ts","../src/core/Poseidon2.ts","../src/core/Poseidon2Params.ts"],"sourcesContent":["class F1Field {\n  prime: bigint;\n  zero = BigInt(0);\n  one = BigInt(1);\n  constructor(prime: bigint) {\n    this.prime = prime;\n  }\n  e(x: number | bigint | string) {\n    if (typeof x === \"bigint\") {\n      return x % this.prime;\n    } else {\n      return BigInt(x) % this.prime;\n    }\n  }\n  add(x: bigint, y: bigint) {\n    return (x + y) % this.prime;\n  }\n  sub(x: bigint, y: bigint) {\n    return (this.prime + x - y) % this.prime;\n  }\n  mul(x: bigint, y: bigint) {\n    return (x * y) % this.prime;\n  }\n  square(x: bigint) {\n    return (x * x) % this.prime;\n  }\n  div(x: bigint, y: bigint) {\n    return (x / y) % this.prime;\n  }\n}\n\nexport { F1Field };\n","import { F1Field } from \"./F1Field\";\nimport type { Poseidon2Params } from \"./Poseidon2Params\";\n\nclass Poseidon2 {\n  params: Poseidon2Params;\n  primeField: F1Field;\n  constructor(params: Poseidon2Params, primeField: F1Field) {\n    this.params = params;\n    this.primeField = primeField;\n  }\n  getT() {\n    return this.params.t;\n  }\n  sbox(input: bigint[]): bigint[] {\n    return input.map((x: bigint) => this.sboxP(x));\n  }\n  sboxP(input: bigint): bigint {\n    const input2 = this.primeField.square(input);\n    if (this.params.d == 3) {\n      return this.primeField.mul(input2, input);\n    } else if (this.params.d == 5) {\n      return this.primeField.mul(this.primeField.square(input2), input);\n    } else if (this.params.d == 7) {\n      return this.primeField.mul(\n        this.primeField.square(input2),\n        this.primeField.mul(input2, input)\n      );\n    } else {\n      throw new Error(\"Invalid d paramter, must be 3, 5 or 7\");\n    }\n  }\n  matmulExternal(input: bigint[]): bigint[] {\n    const t = this.params.t;\n    if (t == 2) {\n      const sum = this.primeField.add(input[0], input[1]);\n      input[0] = this.primeField.add(input[0], sum);\n      input[1] = this.primeField.add(input[1], sum);\n    } else if (t == 3) {\n      const sum = this.primeField.add(\n        this.primeField.add(input[0], input[1]),\n        input[2]\n      );\n      input[0] = this.primeField.add(input[0], sum);\n      input[1] = this.primeField.add(input[1], sum);\n      input[2] = this.primeField.add(input[2], sum);\n    } else if (t == 4 || t == 8 || t == 12 || t == 16 || t == 20 || t == 24) {\n      const t4 = t / 4;\n      for (let i = 0; i < t4; i++) {\n        const startIndex = i * 4;\n        let t_0 = input[startIndex];\n        t_0 = this.primeField.add(t_0, input[startIndex + 1]);\n\n        let t_1 = input[startIndex + 2];\n        t_1 = this.primeField.add(t_1, input[startIndex + 3]);\n\n        let t_2 = input[startIndex + 1];\n        t_2 = this.primeField.add(t_2, t_2);\n        t_2 = this.primeField.add(t_2, t_1);\n\n        let t_3 = input[startIndex + 3];\n        t_3 = this.primeField.add(t_3, t_3);\n        t_3 = this.primeField.add(t_3, t_0);\n\n        let t_4 = t_1;\n        t_4 = this.primeField.add(t_4, t_4);\n        t_4 = this.primeField.add(t_4, t_4);\n        t_4 = this.primeField.add(t_4, t_3);\n\n        let t_5 = t_0;\n        t_5 = this.primeField.add(t_5, t_5);\n        t_5 = this.primeField.add(t_5, t_5);\n\n        t_5 = this.primeField.add(t_5, t_2);\n        let t_6 = t_3;\n        t_6 = this.primeField.add(t_6, t_5);\n\n        let t_7 = t_2;\n        t_7 = this.primeField.add(t_7, t_4);\n\n        input[startIndex] = t_6;\n        input[startIndex + 1] = t_5;\n        input[startIndex + 2] = t_7;\n        input[startIndex + 3] = t_4;\n      }\n      const stored = [\n        this.primeField.zero,\n        this.primeField.zero,\n        this.primeField.zero,\n        this.primeField.zero,\n      ];\n      for (let l = 0; l < 4; l++) {\n        stored[l] = input[l];\n        for (let j = 1; j < t4; j++) {\n          stored[l] = this.primeField.add(stored[l], input[4 * j + l]);\n        }\n      }\n      for (let i = 0; i < input.length; i++) {\n        input[i] = this.primeField.add(input[i], stored[i % 4]);\n      }\n    } else {\n      throw new Error(\n        \"Invalid t parameter, must be 2, 3, 4, 8, 12, 16, 20 or 24\"\n      );\n    }\n    return input;\n  }\n  matmulInternal(input: bigint[]): bigint[] {\n    const t = this.params.t;\n    if (t == 2) {\n      const sum = this.primeField.add(input[0], input[1]);\n      input[0] = this.primeField.add(input[0], sum);\n      input[1] = this.primeField.add(\n        this.primeField.add(input[1], input[1]),\n        sum\n      );\n    } else if (t == 3) {\n      const sum = this.primeField.add(\n        this.primeField.add(input[0], input[1]),\n        input[2]\n      );\n      input[0] = this.primeField.add(input[0], sum);\n      input[1] = this.primeField.add(input[1], sum);\n      input[2] = this.primeField.add(\n        this.primeField.add(input[2], input[2]),\n        sum\n      );\n    } else if (t == 4 || t == 8 || t == 12 || t == 16 || t == 20 || t == 24) {\n      let sum = input[0];\n      for (let i = 1; i < t; i++) {\n        sum = this.primeField.add(sum, input[i]);\n      }\n      for (let i = 0; i < input.length; i++) {\n        input[i] = this.primeField.add(\n          this.primeField.mul(this.params.mat_internal_diag_m_1[i], input[i]),\n          sum\n        );\n      }\n    } else {\n      throw new Error(\n        \"Invalid t parameter, must be 2, 3, 4, 8, 12, 16, 20 or 24\"\n      );\n    }\n    return input;\n  }\n  permute(input: bigint[]): bigint[] {\n    const t = this.params.t;\n    if (input.length != t) {\n      throw new Error(\"Invalid input length\");\n    }\n    let current_state = input;\n    this.matmulExternal(current_state);\n    for (let r = 0; r < this.params.rounds_f_beginning; r++) {\n      current_state = this.addRc(current_state, this.params.round_constants[r]);\n      current_state = this.sbox(current_state);\n      this.matmulExternal(current_state);\n    }\n    const p_end = this.params.rounds_f_beginning + this.params.rounds_p;\n    for (let r = this.params.rounds_f_beginning; r < p_end; r++) {\n      current_state[0] = this.primeField.add(\n        current_state[0],\n        this.params.round_constants[r][0]\n      );\n      current_state[0] = this.sboxP(current_state[0]);\n      this.matmulInternal(current_state);\n    }\n    for (let r = p_end; r < this.params.rounds; r++) {\n      current_state = this.addRc(current_state, this.params.round_constants[r]);\n      current_state = this.sbox(current_state);\n      this.matmulExternal(current_state);\n    }\n    return current_state;\n  }\n  addRc(input: bigint[], rc: bigint[]): bigint[] {\n    return input.map((a, i) => this.primeField.add(a, rc[i]));\n  }\n}\n\nexport { Poseidon2 };\n","interface Poseidon2Params {\n  t: number;\n  d: number;\n  rounds_f_beginning: number;\n  rounds_p: number;\n  rounds_f_end: number;\n  rounds: number;\n  mat_internal_diag_m_1: bigint[];\n  _mat_internal: bigint[][];\n  round_constants: bigint[][];\n}\n\nfunction getPoseidon2Params(\n  t: number,\n  d: number,\n  rounds_f: number,\n  rounds_p: number,\n  mat_internal_diag_m_1: bigint[],\n  mat_internal: bigint[][],\n  round_constants: bigint[][]\n): Poseidon2Params {\n  const r = rounds_f / 2;\n  const rounds = rounds_f + rounds_p;\n  return {\n    t,\n    d,\n    rounds_f_beginning: r,\n    rounds_p,\n    rounds_f_end: r,\n    rounds,\n    mat_internal_diag_m_1: mat_internal_diag_m_1,\n    _mat_internal: mat_internal,\n    round_constants: round_constants,\n  };\n}\n\nexport type { Poseidon2Params };\nexport { getPoseidon2Params };\n"],"names":["F1Field","prime","__publicField","x","y","Poseidon2","params","primeField","input","input2","t","sum","t4","i","startIndex","t_0","t_1","t_2","t_3","t_4","t_5","t_6","t_7","stored","l","j","current_state","r","p_end","rc","a","getPoseidon2Params","d","rounds_f","rounds_p","mat_internal_diag_m_1","mat_internal","round_constants","rounds"],"mappings":"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"}